---
title: "Introduction to Raster Package"
author: "Adam M. Wilson"
date: "February 23, 2015"
output: 
  html_document:
    toc: true
    keep_md: true
---


```{r, echo=FALSE, message=FALSE, results='hide', purl=FALSE}
## This chunk automatically generates a text .R version of this script when running within knitr.  You do not need to run this...
input  = knitr::current_input()  # filename of input document
output = paste(tools::file_path_sans_ext(input), 'R', sep = '.')
knitr::purl(input,output,documentation=2,quiet=T)
repo="adammwilson/SpatialAnalysisTutorials/blob/master/R_RasterIntroduction"
knitr::opts_chunk$set(cache=T)

Sys.setenv(PATH="/Library/Frameworks/GDAL.framework/Programs/:/Library/Frameworks/Python.framework/Versions/2.7/bin:/Applications/:${PATH}")
```

----

This script is available:

  * [SpatialAnalysisTutorials repository](`r paste0("http://github.com/",repo)`)
  * Plain text (.R) with commented text 
  [here](`r paste0("https://raw.githubusercontent.com/adammwilson/SpatialAnalysisTutorials/master/R_RasterIntroduction/",output)`)
 

## Starting R on Omega

Remember to `source` the .bashrc file at the `$` prompt:
```{}
source .bashrc
```

And load the raster package (either from your own privaite library or from mine).
```{r}
library(raster)  # OR, 
library(raster,lib.loc="/lustre/scratch/client/fas/geodata/aw524/R/")
```

## Work with climate data

First set the path to the data directory.  You'll need to uncomment the line setting the directory to `lustre/...`.

```{r}
datadir="~/Downloads/bio1-9_30s_bil"
#datadir="/lustre/scratch/client/fas/geodata/aw524/data/"

outputdir="~/scratch/data"
if(!file.exists(outputdir)) dir.create(outputdir,recursive=T)
```

This time, let's look at BIO9, which is the [Mean Temperature of Driest Quarter](http://www.worldclim.org/bioclim):
```{r}
## first define the path to the data:
file=paste0(datadir,"/bio_9.bil") 
## now use that to load the raster dataset:
data=raster(file)
data
```


## Calling outside functions
R can do almost anything, but it isn't always the fastest at it...  For example, let's compare cropping a tif file using the `raster` package and `gdal_translate`:

First let's do it using the `crop` function:
```{r}
r1 = crop(data, extent(-77,-74.5,6,7))
r1
```


To call functions using the `system` command, you first need to _assemble_ the text string equivalent to what you would run on the command line outside of R.  For example:
```{r}
paste0("gdal_translate -projwin -77 7 -74.5 6 ",file, " ",outputdir,"/cropped.tif")
```

We can save that as an object and _wrap_ it in with a `system()` call to actually run it:
```{r}
cmd=paste0("gdal_translate -projwin -77 7 -74.5 6 ",file, " ",outputdir,"/cropped.tif")
system(cmd)
```

Or even do it all at once.  The depth of nested commands is a matter of personal taste (being consise vs. being clear).  
```{r}
system(paste0("gdal_translate -projwin -77 7 -74.5 6 ",file, " ",outputdir,"/cropped.tif"))
```


### Processing speed

To compare processing speed, let's use the `system.time` function to record how long the operation takes.  To make it fair, we'll write the output tif to disk (rather than keeping it in RAM).  

```{r}
t1=system.time(
  r1 <<- crop(data,
              extent(-77,-74.5,6,7),
              file=paste0(outputdir,"/cropped.tif"),
              overwrite=T))
```

And let's run it one more time and time it to compare:
```{r}
t2=system.time(
  system(
    paste0("gdal_translate -projwin -77 7 -74.5 6 ",file, " ",outputdir,"/cropped.tif")
    )
  )
```



The `crop` command took `r t1[[3]]` seconds, while `gdal_translate` took `r t2[[3]]`.  That's a `r round(100*(t1[[3]]-t2[[3]])/t1[[3]],1)`X speedup!  Whether this matters to you depends on the scale of your project.


## Another example: gdalwarp
But there are programs that go beyond the existing functionality of R, so `system()` can be a useful way to keep your entire workflow in R and call other programs as needed.  For example, it's common to aquire data in different spatial _projections_ that need to be reprojected to a common format prior to analysis.  A great tool for this is `gdalwarp`, which can also mosaic and perform some simple mosaicing procedures (such as taking the mean of multiple layers).

```{r}
command=paste0("gdalwarp -r cubic -t_srs '+proj=utm +zone=11 +datum=WGS84' ",outputdir,"/cropped.tif", " ",outputdir,"/reprojected.tif ")
system(command)
```

